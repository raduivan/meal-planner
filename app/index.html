<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Meal Planner — Planner</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:2rem;line-height:1.4}
    .card{border:1px solid #eee;border-radius:12px;padding:1rem}
    .btn{padding:.55rem .9rem;border:0;border-radius:10px;background:#0b57d0;color:#fff;font-weight:600;cursor:pointer}
    .btn-ghost{padding:.45rem .8rem;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
    input,select{padding:.55rem;border:1px solid #ddd;border-radius:10px}
    .row{display:flex;gap:.5rem;align-items:center}
    a.top{color:#0b57d0;text-decoration:none;font-weight:600}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{padding:.6rem;border-bottom:1px solid #eee}
    th{text-align:left;background:#fafafa}
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between;margin-bottom:1rem">
    <div>
      <h1 style="margin:0">Planner</h1>
      <div style="color:#555">Plan days & weeks. Generate a shopping list.</div>
    </div>
    <div class="row" id="authbar" style="position:relative;z-index:10">
      <a class="top" href="/admin.html">Admin</a>
      <div id="who" style="margin-left:1rem;color:#555">Not signed in</div>
      <button id="authBtn" type="button" class="btn" style="margin-left:.5rem">Sign in with Google</button>
    </div>
  </div>

  <div id="msg" style="display:none;padding:.6rem .8rem;border-radius:10px;background:#e8f0fe;color:#174ea6;margin:.5rem 0"></div>

  <!-- Daily planner -->
  <h2>Daily planner</h2>
  <div class="card" style="max-width:900px;margin:.75rem 0;">
    <div class="row" style="flex-wrap:wrap;gap:1rem">
      <label>Date<br><input id="planDate" type="date"></label>
      <div class="card" style="padding:.75rem">
        <div style="font-weight:600;margin-bottom:.4rem;">Targets</div>
        <div class="row" style="flex-wrap:wrap;gap:.6rem">
          <label>kcal<br><input id="tKcal" type="number" min="0" step="1" value="2200" style="width:100px"></label>
          <label>P (g)<br><input id="tP" type="number" min="0" step="1" value="150" style="width:100px"></label>
          <label>C (g)<br><input id="tC" type="number" min="0" step="1" value="220" style="width:100px"></label>
          <label>F (g)<br><input id="tF" type="number" min="0" step="1" value="70" style="width:100px"></label>
          <button id="saveTargets" class="btn" type="button">Save targets</button>
        </div>
        <div id="targetsSaved" style="display:none;margin-top:.4rem;color:#137333;">Targets saved ✓</div>
      </div>
    </div>

    <div class="row" style="flex-wrap:wrap;gap:.75rem;margin-top:.75rem">
      <label>Meal<br>
        <select id="mealType">
          <option>breakfast</option><option>lunch</option><option>dinner</option><option>snack</option>
        </select>
      </label>
      <label>Recipe<br><select id="mealRecipe" style="min-width:250px"></select></label>
      <label>Grams<br><input id="mealGrams" type="number" min="1" step="1" value="100" style="width:120px"></label>
      <button id="addMealBtn" class="btn">Add to day</button>
    </div>

    <div class="card" style="background:#fafafa;margin-top:.6rem">
      <div class="row" style="gap:.6rem;flex-wrap:wrap">
        <button id="suggestBtn" type="button" class="btn" style="background:#155e75">Suggest grams (hit kcal)</button>
        <div id="suggestOut" style="color:#444"></div>
        <button id="applySuggestBtn" type="button" class="btn-ghost" style="display:none">Apply grams</button>
      </div>
    </div>

    <div id="totals" style="font-weight:600;margin-top:.5rem">Totals: kcal 0 · P 0g · C 0g · F 0g</div>
    <div id="remaining" style="font-weight:600;color:#555">Remaining: kcal — · P —g · C —g · F —g</div>
    <ul id="mealsList" style="padding-left:1rem;margin:0"></ul>
  </div>

  <!-- Weekly overview -->
  <h2>Weekly overview</h2>
  <div class="card" style="max-width:900px;margin:.75rem 0;">
    <div style="color:#555;margin-bottom:.5rem">Week of <span id="weekRange"></span></div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>Date</th><th style="text-align:right">kcal</th><th style="text-align:right">P</th><th style="text-align:right">C</th><th style="text-align:right">F</th><th style="text-align:right">Remaining</th></tr></thead>
        <tbody id="weekBody"></tbody>
      </table>
    </div>
    <button id="refreshWeek" class="btn" type="button" style="margin-top:.5rem">Refresh week</button>
  </div>

  <!-- Shopping list -->
  <h2>Shopping list (for this week)</h2>
  <div class="card" style="max-width:900px;margin:.75rem 0;">
    <div class="row" style="gap:.6rem;flex-wrap:wrap">
      <button id="genShop" class="btn" type="button">Generate shopping list</button>
      <button id="downloadCSV" class="btn-ghost" type="button">Download CSV</button>
      <div style="color:#555">Note: includes only recipes created “from ingredients”.</div>
    </div>
    <div id="shopInfo" style="margin-top:.5rem;color:#555"></div>
    <ul id="shopList" style="padding-left:1rem;margin-top:.5rem"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, getDocs, doc, setDoc, getDoc, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyT1R-qx5aFCsizhRMeP1hz1pdJaLLjqk",
      authDomain: "meal-planner-474313.firebaseapp.com",
      projectId: "meal-planner-474313",
      storageBucket: "meal-planner-474313.appspot.com",
      messagingSenderId: "127147945973",
      appId: "1:127147945973:web:e2bffc4a702705c463babc"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const $=(id)=>document.getElementById(id);
    const showMsg=(t,ok=true)=>{ const m=$('msg'); m.textContent=t; m.style.display='block'; m.style.background=ok?'#e8f0fe':'#fde7e9'; m.style.color=ok?'#174ea6':'#a50e0e'; setTimeout(()=>m.style.display='none',2500); };
    const todayStr=()=>{ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; };

    $('authBtn').onclick = async () => {
      try { if (auth.currentUser) return void (await signOut(auth));
            await signInWithPopup(auth, provider);
      } catch { const {signInWithRedirect}=await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"); await signInWithRedirect(auth, provider); }
    };
    onAuthStateChanged(auth, (u)=> {
      $('who').textContent = u ? `Signed in as ${u.displayName||u.email}` : 'Not signed in';
      $('authBtn').textContent = u ? 'Sign out' : 'Sign in with Google';
      bootstrap();
    });

    // Planner refs/state
    const planDateEl=$('planDate'); planDateEl.value=todayStr();
    const mealTypeEl=$('mealType'), mealRecipeEl=$('mealRecipe'), mealGramsEl=$('mealGrams');
    const totalsEl=$('totals'), remainingEl=$('remaining'), mealsListEl=$('mealsList');
    const tKcalEl=$('tKcal'), tPEl=$('tP'), tCEl=$('tC'), tFEl=$('tF'), saveTargetsBtn=$('saveTargets'), targetsSavedEl=$('targetsSaved');
    const suggestBtn=$('suggestBtn'), suggestOut=$('suggestOut'), applySuggestBtn=$('applySuggestBtn');
    let currentTotals={kcal:0,p:0,c:0,f:0}, currentRemaining={kcal:0,p:0,c:0,f:0}, lastSuggestion=null;

    planDateEl.addEventListener('change', ()=>{ loadMealsAndTargets(planDateEl.value); loadWeekOverview(planDateEl.value); });

    // Recipes dropdown (ingredients-only)
    async function fillRecipeSelect(){
      mealRecipeEl.innerHTML='<option disabled selected>Loading…</option>';
      try {
        const snap=await getDocs(query(
          collection(db,'recipes'),
          orderBy('createdAt','desc')
        ));
        mealRecipeEl.innerHTML='';
        snap.forEach(s=>{
          const r=s.data();
          if (r.fromIngredients !== true) return;
          const o=document.createElement('option');
          o.value=s.id; o.textContent=r.name;
          o.dataset.kcal=r.caloriesPer100||0; o.dataset.p=r.proteinPer100||0; o.dataset.c=r.carbsPer100||0; o.dataset.f=r.fatPer100||0;
          mealRecipeEl.appendChild(o);
        });
        if(!mealRecipeEl.value && mealRecipeEl.firstChild) mealRecipeEl.firstChild.selected=true;
        if(!mealRecipeEl.firstChild){
          const opt=document.createElement('option');
          opt.disabled=true; opt.selected=true; opt.textContent='No ingredient-based recipes yet.';
          mealRecipeEl.appendChild(opt);
        }
      } catch (err) {
        console.error('Failed to load recipes', err);
        mealRecipeEl.innerHTML='';
        const opt=document.createElement('option');
        opt.disabled=true; opt.selected=true; opt.textContent='Failed to load recipes';
        mealRecipeEl.appendChild(opt);
      }
    }

    // Targets save
    saveTargetsBtn.onclick = async ()=>{
      const u=auth.currentUser; if(!u) return showMsg('Sign in first', false);
      const dateStr=planDateEl.value||todayStr();
      await setDoc(doc(db,'plans',u.uid,'days',dateStr), {
        targets:{kcal:+tKcalEl.value||0,p:+tPEl.value||0,c:+tCEl.value||0,f:+tFEl.value||0,updatedAt:serverTimestamp()}
      }, {merge:true});
      targetsSavedEl.style.display='block'; setTimeout(()=>targetsSavedEl.style.display='none',1500);
      loadMealsAndTargets(dateStr); loadWeekOverview(dateStr);
    };

    // Load meals + totals/remaining
    async function loadMealsAndTargets(dateStr){
      mealsListEl.innerHTML='<li style="color:#777">Loading…</li>';
      const u=auth.currentUser; if(!u){ mealsListEl.innerHTML='<li>Sign in to view your plan.</li>'; totalsEl.textContent='Totals: —'; remainingEl.textContent='Remaining: —'; return; }
      const dayRef=doc(db,'plans',u.uid,'days',dateStr); const daySnap=await getDoc(dayRef);
      if (daySnap.exists() && daySnap.data().targets){ const t=daySnap.data().targets; tKcalEl.value=t.kcal??tKcalEl.value; tPEl.value=t.p??tPEl.value; tCEl.value=t.c??tCEl.value; tFEl.value=t.f??tFEl.value; }

      const mealsCol=collection(db,'plans',u.uid,'days',dateStr,'meals');
      const snap=await getDocs(query(mealsCol, orderBy('createdAt')));
      mealsListEl.innerHTML=''; let kcal=0,p=0,c=0,f=0;
      snap.forEach(s=>{
        const m=s.data(); const g=+m.grams||0;
        kcal+=(m.per100?.kcal||0)*g/100; p+=(m.per100?.p||0)*g/100; c+=(m.per100?.c||0)*g/100; f+=(m.per100?.f||0)*g/100;
        const li=document.createElement('li'); li.className='row';
        const label=document.createElement('span'); label.textContent=`${m.mealType}: ${m.recipeName} —`;
        const gramsInput=document.createElement('input'); gramsInput.type='number'; gramsInput.min='1'; gramsInput.step='1'; gramsInput.value=String(g); gramsInput.style.width='90px';
        const gSuffix=document.createElement('span'); gSuffix.textContent='g';
        const saveBtn=document.createElement('button'); saveBtn.textContent='Save'; saveBtn.className='btn'; saveBtn.style.background='#137333';
        const delBtn=document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='btn'; delBtn.style.background='#a50e0e';
        saveBtn.onclick=async()=>{ const ng=+gramsInput.value; if(!ng||ng<=0) return showMsg('Grams must be > 0',false); await updateDoc(s.ref,{grams:ng}); showMsg('Updated'); loadMealsAndTargets(dateStr); loadWeekOverview(dateStr); };
        delBtn.onclick=async()=>{ await deleteDoc(s.ref); showMsg('Deleted'); loadMealsAndTargets(dateStr); loadWeekOverview(dateStr); };
        li.append(label,gramsInput,gSuffix,saveBtn,delBtn); mealsListEl.appendChild(li);
      });
      currentTotals={kcal:Math.round(kcal),p:+p.toFixed(1),c:+c.toFixed(1),f:+f.toFixed(1)};
      totalsEl.textContent=`Totals: kcal ${currentTotals.kcal} · P ${currentTotals.p}g · C ${currentTotals.c}g · F ${currentTotals.f}g`;
      const rK=+tKcalEl.value-kcal, rP=+tPEl.value-p, rC=+tCEl.value-c, rF=+tFEl.value-f;
      const overAny = rK<0||rP<0||rC<0||rF<0;
      currentRemaining={kcal:Math.max(0,Math.round(rK)),p:Math.max(0,+rP.toFixed(1)),c:Math.max(0,+rC.toFixed(1)),f:Math.max(0,+rF.toFixed(1))};
      remainingEl.style.color=overAny?'#a50e0e':'#137333';
      remainingEl.textContent=`Remaining: kcal ${currentRemaining.kcal} · P ${currentRemaining.p}g · C ${currentRemaining.c}g · F ${currentRemaining.f}g`;
      suggestOut.textContent=''; applySuggestBtn.style.display='none'; lastSuggestion=null;
    }

    // Add meal
    $('addMealBtn').onclick = async ()=>{
      const u=auth.currentUser; if(!u) return showMsg('Sign in first', false);
      const dateStr=planDateEl.value||todayStr();
      const recipeId=mealRecipeEl.value; const grams=+mealGramsEl.value; const mealType=mealTypeEl.value;
      if(!recipeId||!grams||grams<=0) return showMsg('Pick a recipe and grams > 0', false);
      const opt=mealRecipeEl.selectedOptions[0];
      const per100={kcal:+opt.dataset.kcal||0,p:+opt.dataset.p||0,c:+opt.dataset.c||0,f:+opt.dataset.f||0};
      await addDoc(collection(db,'plans',u.uid,'days',dateStr,'meals'), { mealType, recipeId, recipeName:opt.textContent, grams, per100, createdAt:serverTimestamp() });
      showMsg('Added'); loadMealsAndTargets(dateStr); loadWeekOverview(dateStr);
    };

    // Suggest helper (kcal focus)
    function round5(x){return Math.max(0,Math.round(x/5)*5);}
    suggestBtn.onclick = ()=>{
      const opt=mealRecipeEl.selectedOptions[0]; if(!opt) return showMsg('Pick a recipe', false);
      const per={kcal:+opt.dataset.kcal||0,p:+opt.dataset.p||0,c:+opt.dataset.c||0,f:+opt.dataset.f||0};
      const gramsK=per.kcal>0?100*(currentRemaining.kcal)/per.kcal:NaN;
      const gramsP=per.p>0?100*(currentRemaining.p)/per.p:NaN;
      const gramsC=per.c>0?100*(currentRemaining.c)/per.c:NaN;
      const gramsF=per.f>0?100*(currentRemaining.f)/per.f:NaN;
      const parts=[]; if(isFinite(gramsK))parts.push(`kcal ≈ ${round5(gramsK)}g`); if(isFinite(gramsP))parts.push(`P ≈ ${round5(gramsP)}g`); if(isFinite(gramsC))parts.push(`C ≈ ${round5(gramsC)}g`); if(isFinite(gramsF))parts.push(`F ≈ ${round5(gramsF)}g`);
      if(!parts.length){ suggestOut.textContent='Recipe lacks per-100 values.'; applySuggestBtn.style.display='none'; return; }
      suggestOut.textContent=`For "${opt.textContent}": ${parts.join(' · ')} (rounded to 5g)`;
      const suggestion=isFinite(gramsK)?round5(gramsK):NaN;
      if(isFinite(suggestion)&&suggestion>0){ lastSuggestion={grams:suggestion}; applySuggestBtn.style.display='inline-block'; } else { applySuggestBtn.style.display='none'; lastSuggestion=null; }
    };
    $('applySuggestBtn').onclick = ()=>{ if(!lastSuggestion) return; mealGramsEl.value=String(lastSuggestion.grams); showMsg(`Applied ${lastSuggestion.grams} g`); };

    // Weekly overview helpers
    const weekRangeEl=$('weekRange'), weekBodyEl=$('weekBody'), refreshWeekBtn=$('refreshWeek');
    function dateFromISO(s){const [Y,M,D]=s.split('-').map(Number);return new Date(Y,M-1,D);}
    function isoFromDate(d){const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${d.getFullYear()}-${m}-${day}`;}
    function weekRangeAround(dateStr){ const d=dateFromISO(dateStr); const day=(d.getDay()+6)%7; const mon=new Date(d); mon.setDate(d.getDate()-day); return Array.from({length:7},(_,i)=>{const x=new Date(mon); x.setDate(mon.getDate()+i); return x;}); }
    async function loadWeekOverview(anchorDateStr){
      weekBodyEl.innerHTML=''; const u=auth.currentUser; if(!u){ weekRangeEl.textContent='—'; return; }
      const days=weekRangeAround(anchorDateStr||todayStr()); weekRangeEl.textContent=`${isoFromDate(days[0])} — ${isoFromDate(days[6])}`;
      for(const d of days){
        const dateStr=isoFromDate(d);
        const dayRef=doc(db,'plans',u.uid,'days',dateStr);
        const daySnap=await getDoc(dayRef);
        const targets=daySnap.exists() && daySnap.data().targets ? daySnap.data().targets : {kcal:0,p:0,c:0,f:0};
        const mealsCol=collection(db,'plans',u.uid,'days',dateStr,'meals');
        const snap=await getDocs(mealsCol);
        let kcal=0,p=0,c=0,f=0;
        snap.forEach(s=>{ const m=s.data(); const g=+m.grams||0; kcal+=(m.per100?.kcal||0)*g/100; p+=(m.per100?.p||0)*g/100; c+=(m.per100?.c||0)*g/100; f+=(m.per100?.f||0)*g/100; });
        const rem={kcal:Math.max(0,Math.round((targets.kcal||0)-kcal)),p:Math.max(0,+((targets.p||0)-p).toFixed(1)),c:Math.max(0,+((targets.c||0)-c).toFixed(1)),f:Math.max(0,+((targets.f||0)-f).toFixed(1))};
        const tr=document.createElement('tr'); const overAny=((targets.kcal||0)&&kcal>targets.kcal)||((targets.p||0)&&p>targets.p)||((targets.c||0)&&c>targets.c)||((targets.f||0)&&f>targets.f);
        const td=(t,r=false)=>{const c=document.createElement('td'); c.textContent=t; c.style.textAlign=r?'right':'left'; return c;};
        tr.append(td(dateStr), td(String(Math.round(kcal)),true), td(p.toFixed(1),true), td(c.toFixed(1),true), td(f.toFixed(1),true));
        const remCell=td(`k ${rem.kcal} · P ${rem.p} · C ${rem.c} · F ${rem.f}`,true); remCell.style.color=overAny?'#a50e0e':'#137333'; tr.appendChild(remCell);
        weekBodyEl.appendChild(tr);
      }
    }
    refreshWeekBtn.onclick=()=>loadWeekOverview(planDateEl.value||todayStr());

    // Shopping list (aggregates only recipes with fromIngredients=true)
    const genShopBtn=$('genShop'), downloadBtn=$('downloadCSV'), shopListEl=$('shopList'), shopInfo=$('shopInfo');
    let lastShopping = [];
    async function generateShoppingList(){
      shopListEl.innerHTML='<li style="color:#777">Building…</li>';
      lastShopping = [];
      const u=auth.currentUser; if(!u){ shopInfo.textContent='Sign in to generate'; return; }
      const days=weekRangeAround(planDateEl.value||todayStr()).map(isoFromDate);
      const recipeCache=new Map();
      const needByName=new Map();

      for(const dateStr of days){
        const snap=await getDocs(collection(db,'plans',u.uid,'days',dateStr,'meals'));
        for(const d of snap.docs){
          const m=d.data(); const g=+m.grams||0;
          if(!m.recipeId) continue;
          let rec=recipeCache.get(m.recipeId);
          if(!rec){ const rSnap=await getDoc(doc(db,'recipes',m.recipeId)); rec=rSnap.exists()?rSnap.data():null; recipeCache.set(m.recipeId,rec); }
          if(!rec || rec.fromIngredients!==true || !Array.isArray(rec.ingredients) || !rec.totalGrams) continue;
          const factor = g / rec.totalGrams;
          rec.ingredients.forEach(it=>{
            const add=(it.grams||0)*factor;
            if(add<=0) return;
            const key=it.name || it.ingredientId || 'Unknown';
            needByName.set(key,(needByName.get(key)||0)+add);
          });
        }
      }
      shopListEl.innerHTML='';
      lastShopping = Array.from(needByName.entries()).map(([name,grams])=>({name,grams:Math.round(grams)})).sort((a,b)=>a.name.localeCompare(b.name));
      if(!lastShopping.length){ shopListEl.innerHTML='<li style="color:#777">No ingredient-based recipes in this week.</li>'; shopInfo.textContent=''; return; }
      let total=0;
      lastShopping.forEach(it=>{
        const li=document.createElement('li');
        const kg=(it.grams/1000);
        li.textContent=`${it.name}: ${it.grams} g`+(kg>=1?` (${kg.toFixed(2)} kg)`:``);
        shopListEl.appendChild(li); total++;
      });
      shopInfo.textContent=`Items: ${total}.`;
    }
    genShopBtn.onclick = generateShoppingList;

    // Download CSV
    downloadBtn.onclick = ()=>{
      if (!lastShopping.length) return showMsg('Generate first', false);
      const rows=[['Ingredient','Grams','Kg'], ...lastShopping.map(it=>[it.name,String(it.grams),(it.grams/1000).toFixed(3)])];
      const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='shopping-list.csv'; a.click(); URL.revokeObjectURL(url);
    };

    async function bootstrap(){
      await fillRecipeSelect();
      await loadMealsAndTargets(planDateEl.value);
      await loadWeekOverview(planDateEl.value);
    }
    bootstrap();
  </script>
</body>
</html>
